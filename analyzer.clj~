#!/usr/bin/env bb
(defn non-ascii [word]

  )

(defn single-word [word]
(if (re-find #"^[^\s]+$" word) true false)
)

(defn special-chars [word]
  (if (re-find #"[^\w]" word) true false)
  )

(defn sorted? [words]
  (= words (sort words)))

(defn stats [words]
  {:count (count words)
   :max-length (apply max (map count words))
   :min-length (apply min (map count words))
   :distinct (apply distinct? words)
   :single-words (every? single-word words)
   :special-chars (some special-chars words)
   :empty-lines (some empty? words)
   :sorted (sorted? words)
   }
  )

(defn quality [stats]
  (let [fns [#(if (:sorted %) 1 0) 
             #(if (:empty-lines %)  -1 0)
             #(if (:single-words %) 1 0)
             #(if (:special-chars %) -1 0)
             #(if (:distinct %) 1 0)
             #(if (> 100 (:count %)) 1 0)
             #(if (> 12 (:max-length %)) 1 -1)
             #(if (< 2 (:min-length %)) 1 -1)]
        vals (map #(or (% stats) 0) fns)        
        ]
    (reduce + vals)
    ))




(defn analyze-file [file]
  (let [text (slurp file)
        words (into [] (.split  text "\n"))
        stats (stats words)
        ext (assoc stats :file file
                   :quality (quality stats))        
        ]
    ext)
  )

(defn stats-text [stats]
  (str
   "## " (:file stats) "\n"
   "- quality : " (:quality stats) "\n"
   "- count : " (:count stats) "\n"
   "- sorted : " (:sorted stats) "\n"
   "\n"

   )
  )

(defn dir-files [dir]
  (->> (clojure.java.io/file dir)
       file-seq
       (filter #(.isFile %))
       (filter #(.endsWith (str % ) ".csv"))
       (mapv #(.getPath %))
       )
  )

(defn get-file-stats [files]
   (map analyze-file files))

(defn print-markdown-index [stats]
  (println "Printing index.md...")
  (spit "index.md" (apply str (map stats-text stats)))) 

(defn print-json-index [stats]
  (println "Printing index.json ...")
  (spit "index.json" (json/generate-string stats)))

(defn print-edn-index [stats]
  (println "Printing index.edn ...")
  (spit "index.edn" (edn/



(defn index! []
  (-> "." dir-files get-file-stats print-markdown-index))






(index!)

